<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Blur Up Thumbs</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2rem;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
      }

      img {
        width: 100%;
      }

      code {
        display: block;
        margin-top: 1em;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <h1>Compare Blur Up Thumbs</h1>

    <div class="table">

      <div class="row">
        <div>
          <h3>Original</h3>
          <img data-src="https://image.mux.com/8008zBLgo5nT01eCTYGPQijbhUTMC02d2Mjww00PGjCa9ms/thumbnail.webp?width=320" data-size="320">
          <code></code>
        </div>

        <div>
          <h3>WebP 16px + SVG blur</h3>
          <img data-src="https://image.mux.com/8008zBLgo5nT01eCTYGPQijbhUTMC02d2Mjww00PGjCa9ms/thumbnail.webp?width=16" data-size="16" data-blur="svg">
          <code></code>
        </div>

        <div>
          <h3>ThumbHash</h3>
          <img data-src="https://image.mux.com/8008zBLgo5nT01eCTYGPQijbhUTMC02d2Mjww00PGjCa9ms/thumbnail.webp?width=100" data-size="100" data-blur="thumbhash">
          <code></code>
        </div>

        <div>
          <h3>BlurHash</h3>
          <img data-src="https://image.mux.com/8008zBLgo5nT01eCTYGPQijbhUTMC02d2Mjww00PGjCa9ms/thumbnail.webp?width=100" data-size="100" data-blur="blurhash">
          <code></code>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Original</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/b611cfd5-e269-4b36-1adb-3714b51c2c00/public">
          <code></code>
        </div>

        <div>
          <h3>WebP 16px + SVG blur</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/b611cfd5-e269-4b36-1adb-3714b51c2c00/16w" data-size="16" data-blur="svg">
          <code></code>
        </div>

        <div>
          <h3>ThumbHash</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/b611cfd5-e269-4b36-1adb-3714b51c2c00/100w" data-size="100" data-blur="thumbhash">
          <code></code>
        </div>

        <div>
          <h3>BlurHash</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/b611cfd5-e269-4b36-1adb-3714b51c2c00/100w" data-size="100" data-blur="blurhash">
          <code></code>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Original</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/f955682e-9446-4fca-5659-70adb8f2ba00/public">
          <code></code>
        </div>

        <div>
          <h3>WebP 16px + SVG blur</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/f955682e-9446-4fca-5659-70adb8f2ba00/16w" data-size="16" data-blur="svg">
          <code></code>
        </div>

        <div>
          <h3>ThumbHash</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/f955682e-9446-4fca-5659-70adb8f2ba00/100w" data-size="100" data-blur="thumbhash">
          <code></code>
        </div>

        <div>
          <h3>BlurHash</h3>
          <img data-src="https://imagedelivery.net/tFTZvontmzoTHZT963JqOw/f955682e-9446-4fca-5659-70adb8f2ba00/100w" data-size="100" data-blur="blurhash">
          <code></code>
        </div>
      </div>

    </div>

    <script type="module">
      import { encode, decode } from 'https://cdn.jsdelivr.net/npm/blurhash@2.0.5/dist/index.mjs';
      import { rgbaToThumbHash, thumbHashToDataURL, rgbaToDataURL } from 'https://cdn.jsdelivr.net/npm/thumbhash@0.1.1/thumbhash.js';

      for (const row of document.querySelectorAll('.row')) {
        for (const div of row.children) {

          const blurImg = div.querySelector('img');
          let src = blurImg.dataset.src;
          let size = Number(blurImg.dataset.size);
          let accept = blurImg.dataset.accept;

          if (blurImg.dataset.blur === 'svg') {

            const response = await fetch(src, {
              headers: {
                'Accept': accept ?? 'image/webp',
              },
            });

            const arrayBuffer = await response.arrayBuffer();
            const base64String = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
            const blurDataURL = `data:${response.headers.get('content-type')};base64,${base64String}`;
            const image = await loadImage(src);
            const aspectRatio = image.width / image.height;
            src = `data:image/svg+xml;charset=utf-8,${svgBlurImage(blurDataURL, 320, 320 / aspectRatio)}`;

            const blurCode = div.querySelector('code');
            blurCode.textContent = `${base64String}`;
          }
          else if (blurImg.dataset.blur === 'blurhash') {

            const image = await loadImage(src);
            // const resized = await resizeImage(image, size);
            const imageData = getImageData(image);
            const blurhash = encode(imageData.data, imageData.width, imageData.height, 4, 4);
            const pixels = decode(blurhash, imageData.width, imageData.height);
            src = rgbaToDataURL(imageData.width, imageData.height, pixels);

            const blurCode = div.querySelector('code');
            blurCode.textContent = `${blurhash}`;
          }
          else if (blurImg.dataset.blur === 'thumbhash') {

            const image = await loadImage(src);
            // const resized = await resizeImage(image, size);
            const imageData = getImageData(image);
            const thumbhash = rgbaToThumbHash(imageData.width, imageData.height, imageData.data);
            src = thumbHashToDataURL(thumbhash);

            const blurCode = div.querySelector('code');
            blurCode.textContent = `${binaryToBase64(thumbhash)}`;
          }

          div.querySelector('img').src = src;
        }
      }

      function svgBlurImage(blurDataURL, width, height) {
        const svg = /*html*/`<svg xmlns="http://www.w3.org/2000/svg" ${width ? `width="${width}"` : ''} ${height ? `height="${height}"` : ''}><filter id="b" color-interpolation-filters="sRGB"><feGaussianBlur stdDeviation="20"/><feComponentTransfer><feFuncA type="discrete" tableValues="1 1"/></feComponentTransfer></filter><g filter="url(#b)"><image width="100%" height="100%" href="${blurDataURL}"/></g></svg>`;
        return svg.replace(/#/g, '%23');
      }

      async function loadImage(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = (...args) => reject(args);
          img.crossOrigin = 'anonymous';
          img.src = src;
        });
      }

      function getImageData(image) {
        const canvas = document.createElement('canvas');
        canvas.width = image.width;
        canvas.height = image.height;
        const context = canvas.getContext('2d');
        context.drawImage(image, 0, 0);
        return context.getImageData(0, 0, image.width, image.height);
      }

      function binaryToBase64(binary) {
        return btoa(String.fromCharCode(...binary));
      }

      async function resizeImage(image, width) {
        if (image.width <= width) return image;

        const scale = width / Math.max(image.width, image.height)

        return await createImageBitmap(image, {
          resizeWidth: Math.round(image.width * scale),
          resizeHeight: Math.round(image.height * scale),
        });
      }

      function toWebpDataURL(imageData) {
        const canvas = document.createElement('canvas');
        canvas.width = imageData.width;
        canvas.height = imageData.height;
        const context = canvas.getContext('2d');
        context.putImageData(imageData, 0, 0);
        return canvas.toDataURL('image/webp');
      }

    </script>

  </body>
</html>
